{% extends "layout.html" %}
{% block content %}
{{render_menu|safe}}
<style type="text/css">
    .flot-placeholder{width:350px;height:300px;}        
</style>
<!--[if lte IE 8]><script language="javascript" type="text/javascript" src="http://www.pureexample.com/js/flot/excanvas.min.js"></script><![endif]-->
<script type="text/javascript" src="http://www.pureexample.com/js/flot/jquery.flot.min.js"></script>
<script type="text/javascript">
  function process_annc(ele){
    var parent_tr = $(ele).parents('tr').eq(-1)
    $.ajax({
          url : "/switch_device_permit",
          data : {"device_id": parent_tr.data("id"),
                  "is_permit": $(ele).prop('checked')},
          dataType : "json",
          type : "post",
          error : function(data){
            alert('something went wrong')
          },
          success: function(data){
            if(data['status']=='failed'){
              alert(data['text'])
            }
          }
        })
  }
  $(function(){
    $('.admin_switch').bootstrapToggle({
      on: '是',
      off: '否',
      size: 'mini',
      onstyle: 'primary',
      offstyle: 'outline-primary',
      width: '4em',
      height: '2em'
    });
    $('.admin_switch').change(function(){
      process_annc(this)
    })
  })
</script>
<script type="text/javascript">
  var options = {
      series: {
          lines: { show: true },
          points: {
              radius: 3,
              show: true
          }
      },
      grid: {
          hoverable: true,
          clickable: true
      },
      xaxis: {
         mode: "time",
         timeformat: "%y/%m/%d %H:%M:%S"
       },
      zoom: {
          interactive: true
      },
      pan: {
          interactive: true,
          enableTouch: true
      },
      colors: ["#708fff"]
  };
  Date.prototype.format = function (fmt) { 
      var o = {
          "M+": this.getMonth() + 1, //月份 
          "d+": this.getDate(), //日 
          "h+": this.getHours(), //小时 
          "m+": this.getMinutes(), //分 
          "s+": this.getSeconds(), //秒 
          "q+": Math.floor((this.getMonth() + 3) / 3), //季度 
          "S": this.getMilliseconds() //毫秒 
      };
      if (/(y+)/.test(fmt)) fmt = fmt.replace(RegExp.$1, (this.getFullYear() + "").substr(4 - RegExp.$1.length));
      for (var k in o)
      if (new RegExp("(" + k + ")").test(fmt)) fmt = fmt.replace(RegExp.$1, (RegExp.$1.length == 1) ? (o[k]) : (("00" + o[k]).substr(("" + o[k]).length)));
      return fmt;
  }
</script>
<table class="table table-striped table-primary">
  <thead>
    <tr>
      <th>最後連線時間</th>
      <th>ip位址</th>
      <th>電腦名稱</th>
      <th>連線允許</th>
      <th>數據圖</th>
    </tr>
  </thead>
  <tbody>
    {% for device in devices %}
      {% set d = device.get_dict() %}
      <tr data-id="{{d['id']}}">
        <td>
          {{d['update_time']|safe}}
        </td>
        <td>
          {{d['ip']|safe}}
        </td>
        <td>
          {{handle_field_catch(d,'node')|safe}}
          <ul>
            {% for field_name in field_names %}
              <li>
                {{get_field_name(field_name)}}:{{ handle_field_catch(d,field_name)|safe }}
              </li>
            {% endfor %}
          </ul>
        </td>
        <td>
          {% if is_admin %}
            {% set tmp = 'checked' if d.is_permit else '' %}
            <input type="checkbox" class="admin_switch" {{tmp}}>
          {% else %}
            {% set tmp = '是' if d.is_permit else '否' %}
            {{tmp}}
          {% endif %}
        </td>
        <td>
          {% set tmp = get_sensor_data(d['id']) %}
          {% if tmp['flag'] %}
          <div class="flot-placeholder" id="flot-placeholder-{{d['id']}}"></div>
          <script type="text/javascript">
            var tmp;
            function update_{{d['id']}}(){
              $.ajax(
                {
                  type : "post",
                  url : '/get_sensor_data',
                  dataType : "json",
                  data:{device_id: "{{d['id']}}"},
                  global:false,
                  success: function(data)
                   {
                      $.plot($("#flot-placeholder-{{d['id']}}"), eval(data), options);
                      tmp = data
                      window.setTimeout(function(){
                          update_{{d['id']}}()
                        },2000)
                   },
                  error : function(data){
                    alert('系統發生錯誤')
                  }
                })
            }
            $(document).ready(function () {
              dataset = {{tmp['dataset']|safe}}
              $.plot($("#flot-placeholder-{{d['id']}}"), dataset, options);
              window.setTimeout(function(){
                update_{{d['id']}}()
              },2000)
            })
          </script>
          {% endif %}
        </td>
      </tr>
    {% endfor %}
  </tbody>
</table>
<div id="tooltip" style="position: absolute; border: 1px solid rgb(255, 221, 221); padding: 2px; background-color: #3c54ac;color:#fff; opacity: 0.8; top: 274px; left: 371px; display: none;"></div>
<script type="text/javascript">
  $(document).ready(function () {
      
      $(".flot-placeholder").bind("plothover", function (event, pos, item) {

          if (!pos.x || !pos.y) {
              return;
          }
          if (item) {
              var x = item.datapoint[0].toFixed(2),
                  y = item.datapoint[1].toFixed(2);
              var date = new Date(+x)
              $("#tooltip").html("[" + date.format("yyyy-MM-dd hh:mm:ss") + "," + y + "]")
                  .css({top: item.pageY+5, left: item.pageX+5})
                  .fadeIn(200);
          } else {
              $("#tooltip").hide();
          }
          
      });
  });
</script>
{% endblock %}